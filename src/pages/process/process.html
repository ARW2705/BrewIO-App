<ion-content>

  <ion-grid id="process-grid">

    <ng-container *ngIf="recipe && selectedBatch">

      <!-- MANUAL step -->
      <ion-row *ngIf="getViewStepType() == 'manual'">

        <!-- Step name -->
        <ion-col col-12>
          <h2>{{ getViewStepName() }}</h2>
        </ion-col>

        <!-- Step description -->
        <ion-col col-12>
          <p>{{ getViewStepDescription() }}<p>
        </ion-col>
      </ion-row>

      <!-- TIMER step -->
      <ion-row *ngIf="getViewStepType() == 'timer'">

        <!-- Central control for concurrent timers -->
        <ion-row  *ngIf="viewStepIndex == selectedBatch.currentStep"
                  id="timer-master-controls">
          <ion-col col-12>
            <h2>All Timer Controls</h2>
          </ion-col>

          <!-- Start all timers in step -->
          <ion-col col-6>
            <button ion-button
                    color="primary"
                    class="button timer-button"
                    (click)="startAllTimers()">
              Start All
            </button>
          </ion-col>

          <!-- Stop all timers in step -->
          <ion-col col-6>
            <button ion-button
                    color="primary"
                    class="button timer-button"
                    (click)="stopAllTimers()">
              Stop All
            </button>
          </ion-col>

          <!-- Add 1 minute to all timers in step -->
          <ion-col col-6>
            <button ion-button
                    color="primary"
                    class="button timer-button"
                    (click)="addToAllTimers()">
              +1min All
            </button>
          </ion-col>

          <!-- Reset all timers in step -->
          <ion-col col-6>
            <button ion-button
                    color="secondary"
                    class="button timer-button"
                    (click)="resetAllTimers()">
              Reset All
            </button>
          </ion-col>

          <!-- Toggle all timer descriptions in step -->
          <ion-col col-12>
            <button ion-button
                    class="button timer-button"
                    (click)="toggleShowDescription()">
              {{ showDescription ? 'Hide Descriptions': 'Show Descriptions' }}
            </button>
          </ion-col>

        </ion-row>

        <!-- Individual timers -->
        <ng-container *ngFor="let timer of timers[currentTimers]">

          <!-- Timers that are not the current step -->
          <ion-row *ngIf="viewStepIndex != selectedBatch.currentStep" class="timer-summary-container">

            <!-- Timer name -->
            <ion-col col-12>
              <h2>{{ timer.timer.name }}</h2>
            </ion-col>

            <!-- Time duration -->
            <ion-col col-6>
              <span>Duration: {{ getFormattedDurationString(timer.timer.duration) }}</span>
            </ion-col>

            <!-- Number of intervals -->
            <ion-col col-6>
              <span>Intervals: {{ timer.timer.splitInterval }}</span>
            </ion-col>

            <!-- Timer description -->
            <ion-col col-12>
              <p>{{ timer.timer.description }}<p>
            </ion-col>
          </ion-row>

          <!-- Timers that are on the current step -->
          <ng-container *ngIf="viewStepIndex == selectedBatch.currentStep">

            <ion-row class="timer-row">

              <!-- Timer name -->
              <ion-col col-12>
                <h2>{{ timer.timer.name }}</h2>
              </ion-col>

              <!-- Timer description -->
              <ion-col col-12
                       *ngIf="showDescription"
                       class="description">
                <p>{{ timer.timer.description }}</p>
              </ion-col>

            </ion-row>

            <ion-row align-items-center class="timer-row">

              <!-- Timer progress circle -->
              <ion-col>
                <progress-circle [settings]="timer.settings"
                                 (click)="toggleTimerControls(timer)">
                </progress-circle>
              </ion-col>

              <!-- Individual timer controls -->
              <ion-col *ngIf="isConcurrent && timer.show"
                       [@slideUpDown]
                       class="timer-individual-controls">

                <!-- Start the individual timer -->
                <ion-row>
                  <button ion-button
                          color="primary"
                          class="button timer-button"
                          (click)="startSingleTimer(timer)">
                    Start
                  </button>
                </ion-row>

                <!-- Stop the individual timer -->
                <ion-row>
                  <button ion-button
                          color="primary"
                          class="button timer-button"
                          (click)="stopSingleTimer(timer)">
                    Stop
                  </button>
                </ion-row>

                <!-- Add one minute to the individual timer -->
                <ion-row>
                  <button ion-button
                          color="primary"
                          class="button timer-button"
                          (click)="addToSingleTimer(timer)">
                    +1min
                  </button>
                </ion-row>

                <!-- Reset the individual timer -->
                <ion-row>
                  <button ion-button
                          color="secondary"
                          class="button timer-button"
                          (click)="resetSingleTimer(timer)">
                    Reset
                  </button>
                </ion-row>

              </ion-col>
            </ion-row>

          </ng-container>

        </ng-container>

      </ion-row>

      <!-- CALENDAR steps -->
      <ion-row *ngIf="getViewStepType() == 'calendar'">

        <!-- Calendar step name -->
        <ion-col col-12>

          <!-- Toggle step description visibility -->
          <button class="button expand-button"
                  (click)="toggleShowDescription()">
            <h2>{{ getViewStepName() }}</h2>
          </button>
        </ion-col>

        <!-- Step description -->
        <ion-col  col-12
                  class="description"
                  *ngIf="viewStepIndex != selectedBatch.currentStep || showDescription">
          <p>{{ getViewStepDescription() }}</p>
        </ion-col>

        <!-- If the calendar step has been started, show information about next part of step -->
        <ion-col  col-12
                  *ngIf="getViewStepType() == 'calendar' && calendarInProgress()">

          <!-- Description of task to do at end date -->
          <p class="calendar-description">{{ getNextDateSummary() }}</p>

          <!-- List of next dates in calendar for a particular step -->
          <ion-list class="alert-list">
            <h3>Next Checks</h3>
            <ng-container *ngFor="let alert of selectedBatch.alerts | sort:'datetime'">
              <ion-item *ngIf="shouldShowAlert(alert)"
                        [ngClass]="getAlertClass(alert)">

                <!-- Alert description -->
                <p class="alert-description">{{ alert.description || '' }}</p>

                <!-- Alert date -->
                <p class="alert-datetime">{{ alert.datetime | date:'mediumDate' }}</p>

              </ion-item>
            </ng-container>
          </ion-list>

          <!-- Edit the calendar step -->
          <button class="change-button"
                  ion-button
                  (click)="changeDate()">
            Change Dates
          </button>
        </ion-col>

        <!-- Show calendar if step has not been started -->
        <calendar #calendar
                  *ngIf="viewStepIndex == selectedBatch.currentStep && !calendarInProgress()"
                  [data]="getCurrentStepCalendarData()">
        </calendar>
      </ion-row>

      <!-- Step view navigation controls -->
      <ion-row justify-content-between
               id="step-control-buttons">

        <!-- View previous step if not at start -->
        <ion-col>
          <button ion-button
                  color="primary"
                  [disabled]="atViewEnd('prev')"
                  (click)="changeStep('prev')">
            <ion-icon class="nav-process-button"
                      name="arrow-dropleft"></ion-icon>
          </button>
        </ion-col>

        <!-- Complete the step button - only if on current step -->
        <ion-col *ngIf="viewStepIndex == selectedBatch.currentStep
                        && (getViewStepType() != 'calendar' || calendarInProgress())">
          <button ion-button
                  class="nav-process-button"
                  color="primary"
                  (click)="completeStep()">
            Done
          </button>
        </ion-col>

        <!-- Jump to current step - only if not on current step -->
        <ion-col *ngIf="viewStepIndex != selectedBatch.currentStep">
          <button ion-button
                  class="nav-process-button"
                  color="primary"
                  (click)="goToActiveStep()">
            Go To Active
          </button>
        </ion-col>

        <!-- If on calendar step and has not already been started -->
        <ion-col *ngIf="viewStepIndex == selectedBatch.currentStep
                        && getViewStepType() == 'calendar'
                        && !calendarInProgress()">
          <button ion-button
                  class="nav-process-button"
                  color="primary"
                  (click)="startCalendar()">
            Start
          </button>
        </ion-col>

        <!-- View next step if not at end -->
        <ion-col>
          <button ion-button
                  color="primary"
                  [disabled]="atViewEnd('next')"
                  (click)="changeStep('next')">
            <ion-icon class="nav-process-button"
                      name="arrow-dropright"></ion-icon>
          </button>
        </ion-col>
      </ion-row>

    </ng-container>

  </ion-grid>

</ion-content>
